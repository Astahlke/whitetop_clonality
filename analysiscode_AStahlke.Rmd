---
title: Environmental Analysis - How do sites differ and does this determine rates
  of clonality?
author: "Amanda Stahlke"
date: "11/25/2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(BiodiversityR)
library(vegan)
library(goeveg)
library(lme4)
library(MuMIn)
library(rpart)
library(party)
library(subselect)
library(MASS)

library(dplyr)
library(reshape2)
library(ggplot2)
```

```{r prepdata}
gen_env<-na.omit(read.csv("geno_enviro.csv"))
names(gen_env)
#gen_env$BL<-gen_env$bare+gen_env$litter #composite background variable
gen_env$Site<-as.factor(gen_env$Site)
head(gen_env)
```

```{r GNrank}
site_GN_rank <- gen_env %>%
  group_by(Site) %>%
  summarise(unique(GN_Rank))
site_GN_rank 

clone_rate <- gen_env %>%
  group_by(Site) %>%
  summarise(sum(Clone)) %>%
  mutate(clone_rate=1-`sum(Clone)`/15) %>%
  as.data.frame()
merge(clone_rate, site_GN_rank)

stemcts <- gen_env %>%
  # group_by(Site) %>%
  summarise(avg=mean(stem), sd=sd(stem)) %>%
  mutate(avg/(100))

arrange(gen_env, stem) %>%
  dplyr::select(site.plot.subplot, stem)

```

Aggregate site variables for the average and standard deviation across a site.

```{r aggregate_and_GNrank}
#####Veg summary
veg_mat<-aggregate(list("grass"=gen_env$grass,"bare"=gen_env$bare,"draba"=gen_env$Ldraba.cvr,"litter"=gen_env$litter),
                   by=list("Site"=gen_env$Site),FUN=mean)

veg_mat.sd<-aggregate(list("grass"=gen_env$grass,"bare"=gen_env$bare,"draba"=gen_env$Ldraba.cvr,"litter"=gen_env$litter),
                   by=list("Site"=gen_env$Site),FUN=sd)

GN<-read.csv("G_N_bysite.csv")
veg_mat$R_GN<-GN[,"R_GN"]
veg_mat$GN<-GN$site.G.N
veg_mat
```

R_GN is the rank of G/N across sites.
From least to most clonal: Site 1, 6, 3, 5, 2, 4. 
For the following plots, these variables are plotted against the G/N rank. 
I'm not sure how I feel about this because GN isn't uniformly distributed. Sites 3 and 6 have almost the same GN, for example.

```{r vegplotsgrass}
plot(veg_mat$R_GN,veg_mat$grass)
plot(veg_mat$R_GN,veg_mat$bare)
plot(veg_mat$R_GN,veg_mat$litter)
plot(veg_mat$R_GN,veg_mat$draba,xaxt="n",ylim=c(0,60),ylab="% Draba",xlab="Prevalence of Clones")
plot(veg_mat$R_GN,veg_mat$grass,xaxt="n",ylim=c(0,60),ylab="% Grass", xlab="Prevalence of Clones")
plot(veg_mat$R_GN,veg_mat$bare,xaxt="n",ylim=c(0,60),ylab="% Bare",xlab="Prevalence of Clones")
```

Grass is highly variable across sites. Bare ground seems to best seperate the low and high clonal sites.The most clonal sites have the most bare ground (but it's still only about 10%).

Next, look at soil nutrient variables. 
```{r}
cormat <- round(cor(gen_env[,c(7:9,11:dim(gen_env)[2])]),2) # drop texture and site
cormat
# Get upper triangle of the correlation matrix
  get_upper_tri <- function(cormat){
    cormat[lower.tri(cormat)]<- NA
    return(cormat)
  }
  
upper_tri <- get_upper_tri(cormat)
upper_tri

melted_cormat <- melt(upper_tri, na.rm = TRUE)

ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    hjust = 1))+
 coord_fixed()

melted_cormat %>%
  filter(abs(value) >.5 & value <1) %>%
  arrange(desc(value))

melted_cormat %>%
  filter(Var1 == "Clone" |  Var2 == "Clone") %>%
  arrange(desc(value))
```

```{r}
names(gen_env)
env_fact<-gen_env[,11:dim(gen_env)[2]]
names(env_fact)

fact_drops<-c("Ca","Clay","Cu","Salts")
env_fact<-data.frame(env_fact[,-which(names(env_fact)%in%fact_drops)])
head(env_fact)

cormat <- round(cor(env_fact),2)
reshape2::melt(cormat) %>%
  filter(abs(value) >.5 & value <1)
```

Drop Ca, Clay, Cu, and Salts -- why? 

#NMDS of subplots
```{r}
env.mds<-metaMDS(env_fact, distance = "gower", k=4)
stressplot(env.mds)
```

Run 20 stress 0.1058718 
*** Solution reached
Is another interation using previous best necessary? Or just good practice? 


```{r}
env.mds2<-metaMDS(env_fact, distance = "gower", k=4, previous.best = env.mds)
stressplot(env.mds2)
```

Run 20 stress 0.1049917 
*** Solution reached
Non-metric fit is better than linear 


```{r}
dim.result <- dimcheckMDS(env_fact,distance="gower",k=8,trymax = 20)
data.frame(dimension = seq_along(dim.result), stress=dim.result)
```
Stress is still barely above .2 at 2 dimensions, might as well show 3 dims. 

```{r, warning=F, message=F}
env.plot<-ordiplot(env.mds,display = "sites",type="n", choices = c(1,2))
# points(env.mds,display="sites",col=gen_env$Site,cex=1.5,lwd=1.5,choices = c(1,2))
ordisymbol(env.plot, gen_env, "Site", legend=TRUE,cex=2,lwd=2,choices = c(1,2))
# text(env.mds,display = "sites",labels = gen_env$Site)
env.factors<-envfit(env.mds,env_fact, permutations = 999)
plot(env.factors, p.max=0.01)
```

Here, symbols represent the G/N ranking, where 
```{r, warning=F, message=F}
env.plot<-ordiplot(env.mds,display = "sites",type="n", choices = c(1,2))
# points(env.mds,display="sites",col=gen_env$Site,cex=1.5,lwd=1.5,choices = c(1,2))
ordisymbol(env.plot, gen_env, "GN_Rank", legend=TRUE,cex=2,lwd=2,choices = c(1,2))
# text(env.mds,display = "sites",labels = gen_env$Site)
env.factors<-envfit(env.mds,env_fact)
plot(env.factors)
```


Betadispersion - sites. Create a dissimilarity matrix for betdispersion analysis

```{r}
commax<-vegdist(env_fact, method = "gower")

#looks at multivariate dispersion (variance) among SITES
fum<-with(gen_env,betadisper(commax,Site))

plot(fum)
```

###Plotting and Testing

```{r}
#plot(fum,main="",cex.lab=1.5,cex.axis=1.5,label=F,col=c("Gray","Gray"),seg.col = "black",seg.lty = "dotted",sub = "",mgp=c(2.5,0.75,0)) #displays principal coordinates analysis of Years (Year in position of centroid)
#points(fum$vectors[,"PCoA1"],fum$vectors[,"PCoA2"],col=rep(c("Black","Gray"), times = c(4,2)),cex=3,lwd=2,
#       pch=rep(c(19,17),each=6))

boxplot(fum) #variation among sampled points
permutest(fum) #-- Difference in multivariate dispersion between sites
```


```{r}
TukeyHSD(fum)
```


#Making soil variables; soils NMDS
Why these variables?

```{r}
soilz<-gen_env[,c("pH","OM","Nitrate","K","S","Zn","Fe","Mn","Mg","Na","CEC","P")] 
soilz.mds<-metaMDS(soilz,distance = "gower", k=4)
soilz.mds<-metaMDS(soilz,distance = "gower", k=4,previous.best = soilz.mds)

dim.soil.result <- dimcheckMDS(soilz,distance="gower",k=4,trymax = 20)
data.frame(dimension = seq_along(dim.soil.result), stress=dim.soil.result)
```

Run 20 stress 0.08930132 
... Procrustes: rmse 0.0003265606  max resid 0.001486795 
... Similar to previous best
*** Solution reached
```{r}
nut.plot<-ordiplot(soilz.mds,display = "sites",type="n")
ordisymbol(nut.plot, gen_env, "Site", legend=TRUE,cex=2,lwd=2)
nut.factors<-envfit(soilz.mds,soilz)
plot(nut.factors)
```

```{r}
soilz.D <- vegdist(soilz, "gower")
res <- ape::pcoa(soilz.D)
nut.factors<-envfit(soilz.D, soilz, perm=999)

biplot(res, rn=gen_env$Site)
plot(nut.factors, p.max=.06)

#soil variables for multimodel comparison
soil.nut1.pcoa<-res$vectors[,"Axis.1"]
soil.nut2.pcoa<-res$vectors[,"Axis.2"]

barplot(res$values$Relative_eig)
cumsum(res$values$Relative_eig)
cumsum(res2$eig)/sum(res2$eig)

```



```{r}
#soil variables for multimodel comparison
soil.nut1<-soilz.mds$points[,"MDS1"]
soil.nut2<-soilz.mds$points[,"MDS2"]
```


# Global model for multi-model comparison; Clone 0,1

glm() fits a generalized linear model and glmer() fits linear mixed effects models

Global model includes Sand, grass, bare, soil, nmds nutrients 1, nmds nutrients 2
lme allows inclusions of site as a random factor

```{r}
cl_global_glm <- glm(Clone ~ Sand+grass+bare+
                       soil.nut1.pcoa+soil.nut2.pcoa,
                    data=gen_env,family="binomial",
                    na.action = "na.fail",weights = rep(15,dim(gen_env)[1]))
summary(cl_global_glm)

cl_global_site <- glmer(Clone ~ Sand+grass+bare+
                        soil.nut1.pcoa + soil.nut2.pcoa
                     +(1|gen_env$Site),
                     data=gen_env, family="binomial", 
                     na.action = "na.fail",
                     weights = rep(15,dim(gen_env)[1]))
summary(cl_global_site)

anova(cl_global_site, cl_global_glm)
```

Any outlier points outweighing the influence of the glm? 
```{r}
cooksd<-cooks.distance(cl_global_glm)
plot(cooksd)
abline(h = 4*mean(cooksd, na.rm=T), col="red")
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")  # add labels
influential <- as.numeric(names(cooksd)[(cooksd > 4*mean(cooksd, na.rm=T))])

cbind(gen_env[influential, ],soil.nut1[influential],soil.nut2[influential])

```
Remove these subplots and run again?

```{r}
gen_env_pruned <- gen_env[-influential,]

soil.nut1.pcoa_pruned<-res$vectors[-influential,"Axis.1"]
soil.nut2.pcoa_pruned<-res$vectors[-influential,"Axis.2"]

# soil.nut1_pruned <-soilz.mds$points[-influential,"MDS1"]#soil variables for multimodel comparison
# soil.nut2_pruned <-soilz.mds$points[-influential,"MDS2"]

cl_global_glm_pruned<-glm(Clone ~ 
           Sand+grass+bare+
             soil.nut1.pcoa_pruned+soil.nut2.pcoa_pruned,
           data=gen_env_pruned, family="binomial",
           na.action="na.fail",
           weights = rep(13,dim(gen_env_pruned)[1]))

cl_global_glmer_pruned<-glmer(Clone ~ 
           Sand+grass+bare+
             soil.nut1.pcoa_pruned + soil.nut2.pcoa_pruned +
           +(1|gen_env_pruned$Site),
           data=gen_env_pruned, 
           family="binomial", 
           na.action = "na.fail",
           weights = rep(13,dim(gen_env_pruned)[1]))

summary(cl_global_glm_pruned)
summary(cl_global_glm)
```

```{r}

cooksd_pruned<-cooks.distance(cl_global_glm_pruned)
plot(cooksd_pruned)
abline(h = 4*mean(cooksd_pruned, na.rm=T), col="red")
text(x=1:length(cooksd_pruned)+1, y=cooksd_pruned,
     labels=ifelse(cooksd_pruned > 4*mean(cooksd_pruned,na.rm=T),
                   names(cooksd_pruned),""), col="red")  # add labels
influential <- as.numeric(names(cooksd_pruned)
                          [(cooksd_pruned > 4*mean(cooksd_pruned,
                                                   na.rm=T))])
cbind(gen_env_pruned[influential,],
      soil.nut1_pruned[influential],
      soil.nut2_pruned[influential])

```

```{r}
cl_redux1_glmer_pruned<-glmer(Clone ~ 
           grass+bare+
             soil.nut1.pcoa_pruned + soil.nut2.pcoa_pruned +
           +(1|gen_env_pruned$Site),
           data=gen_env_pruned, 
           family="binomial", 
           na.action = "na.fail",
           weights = rep(13,dim(gen_env_pruned)[1]))
summary(cl_redux1_glmer_pruned)

cl_redux2_glmer_pruned <- glmer(Clone ~ 
            grass + bare+
             soil.nut1.pcoa_pruned +
              (1|gen_env_pruned$Site),
             data=gen_env_pruned,family="binomial",
            na.action = "na.fail",
             weights = rep(13,dim(gen_env_pruned)[1]))
summary(cl_redux2_glmer_pruned)

cl_redux3_glmer_pruned <- glmer(Clone ~ 
            grass + soil.nut1.pcoa_pruned +
              (1|gen_env_pruned$Site),
             data=gen_env_pruned,family="binomial",
            na.action = "na.fail",
             weights = rep(13,dim(gen_env_pruned)[1]))
summary(cl_redux3_glmer_pruned)


cl_redux3interaction_glmer_pruned <- glmer(Clone ~ 
            grass * soil.nut1.pcoa_pruned +
              (1|gen_env_pruned$Site),
             data=gen_env_pruned,family="binomial",
            na.action = "na.fail",
             weights = rep(13,dim(gen_env_pruned)[1]))
summary(cl_redux3interaction_glmer_pruned)

anova(cl_redux3interaction_glmer_pruned, cl_redux3_glmer_pruned)
```

Model failed to converge with max|grad| = 0.00115423 (tol = 0.001, component 1)
```{r}
# cl_redux_nutrs_site<-glmer(Clone~grass+bare+Zn+Fe+OM+Mn+Na+(1|gen_env$Site),data=gen_env,family="binomial",na.action = "na.fail")
# summary(cl_redux_nutrs_site)

## This model is nearly unidentifiable
cl_redux_nutrs_glmer_pruned <- glmer(Clone ~
              grass +                         
              K+OM+Fe+Zn+S+Mn
              +  (1|gen_env_pruned$Site),
             data=gen_env_pruned,family="binomial",
            na.action = "na.fail",
             weights = rep(13,dim(gen_env_pruned)[1]))
summary(cl_redux_nutrs_glmer_pruned)

## Dropped K 
cl_redux2_nutrs_glmer_pruned <- glmer(Clone ~ 
              grass+
              OM+Fe+Zn+S+Mn
              +  (1|gen_env_pruned$Site),
             data=gen_env_pruned,family="binomial",
            na.action = "na.fail",
             weights = rep(13,dim(gen_env_pruned)[1]))
summary(cl_redux2_nutrs_glmer_pruned)

dd<-dredge(cl_redux2_nutrs_glmer_pruned)
subset(dd,delta<4)
importance(dd)#)
importance(subset(dd, delta<=2))

```

```{r}
summary(glmer(Clone~
                grass+bare+
                Fe+Mn+(1|gen_env$Site),data=gen_env,family="binomial",na.action = "na.fail"))

```

```{r}
cl_redux2_nutrs_site <- glm(Clone~grass+bare+K+Fe+OM+Mn+Na,data=gen_env,family="binomial",na.action = "na.fail")
summary(cl_redux2_nutrs_site)
```

```{r}
cl_redux3_nutrs_site <- glmer(Clone~grass+bare+Fe+Mn+(1|gen_env$Site),data=gen_env,family="binomial",na.action = "na.fail")
summary(cl_redux3_nutrs_site)
```

```{r}
dd<-dredge(cl_redux2_nutrs_site)
subset(dd,delta<4)
importance(dd)#)
```

```{r}
importance(subset(dd, delta<=2))
```

### Stem density (1-inf)
lmer for continuous cariable: count of stems
```{r}
stem_global_site <- lmer(stem~
                      Sand+grass+bare+
                      soil.nut1+soil.nut2
                      +(1|gen_env$Site),
                      na.action = "na.fail",
                      data=gen_env)

stem_global <- lm(stem~
                      Sand+grass+bare+
                      soil.nut1+soil.nut2,
                      data=gen_env)
summary(stem_global_site)


dd<-dredge(stem_global_site)
subset(dd,delta<4)
importance(subset(dd, delta<=2))

```

paring down the soil data
have to NAomit as missing NH4_N values for rows 1,18,and 32

```{r}
soil<-na.omit(gen_env[,c("Site","pH","OM","Nitrate","K","S","Zn","Fe","Mn","Mg","Na","CEC","P")])
irisHmat <- ldaHmat(soil[,2:dim(soil)[2]],soil$Site)
eleaps(irisHmat$mat,kmin=2)#,H=irisHmat$H,r=irisHmat$r,crit="ccr12")
```

```{r}

fit <- lda(Site ~ K + Mg + Na, data=soil, na.action=na.exclude,
           CV=TRUE)
fit # show results
```


# CAnonical Analysis of Principal Coordinates 
## (as in Andreson & Willis 2003, Biodiversity R package)
In constrained ordination we do not want to display all or even most ofthe compositional variation, but only the variation that can be explained by the used environmental variables, or constraints.

```{r}
gen_env$factClone<-as.factor(gen_env$Clone)

Ordination.model1 <- CAPdiscrim(soilz~factClone,
                                data=gen_env,
                                dist="gower", 
                                axes=3, m=0, add=FALSE)
Ordination.model1


# data(env_fact)
# Ordination.model1 <- CAPdiscrim(env_fact~Site,
#                                 data=gen_env,
#                                 dist="gower",
#                                 axes=2, m=0,
#                                 add=FALSE,
#                                 permutations = 100)
# Ordination.model1

plot1 <- ordiplot(Ordination.model1, type="none")
ordisymbol(plot1, gen_env, "Site", legend=TRUE)
# ordisymbol(plot1, gen_env, "Clone", legend=TRUE)

sitz<-envfit(Ordination.model1,env_fact[,c("grass","bare","Zn","Fe","OM","Mn","Na")], choices = c(1,2))
sitz.text<-envfit(Ordination.model1,gen_env[,c("bare","grass","Mg","Na","K")])
plot(sitz)
plot(sitz.text)
plot2 <- ordiplot(Ordination.model1, type="none",choices = c(1,2))
ordisymbol(plot2, gen_env,"Site", legend = T)
plot(sitz)

```



```{r}
# plot change in classification success against m (#classification dimensions for LDA)
plot(seq(1:14), rep(-1000, 14), xlim=c(1, 14), ylim=c(0, 100), xlab="m",
     ylab="classification success (percent)", type="n")

for (mseq in 1:14) {
  CAPdiscrim.result <- CAPdiscrim(soilz~Site, data=gen_env, 
                                  dist="gower", axes=2, m=mseq)
  points(mseq, CAPdiscrim.result$percent)
}

```

```{r}
stMod.1<-glm(Clone~grass+bare+Zn+Fe+OM+Mn,data=gen_env[gen_env$Site==1,],family="binomial",na.action = "na.fail")
summary(stMod.1)
stepAIC(stMod.1,direction = "both")
```


```{r}
gen_env$factClone<-as.factor(gen_env$Clone)

env.mds2
Ordination.model1 <- CAPdiscrim(soilz~factClone,
                                data=gen_env,
                                dist="gower", 
                                axes=3, m=0, add=FALSE)
Ordination.model1

```

```{r}
plot1 <- ordiplot(Ordination.model1, type="none")
# ordisymbol(plot1, gen_env, "Clone", legend=TRUE)
ordisymbol(plot1, gen_env, "Site", legend=TRUE)
clonz<-envfit(Ordination.model1,soilz)
plot(clonz)
```

Plot change in classification success against m (#classification dimensions for LDA)
```{r}
plot(seq(1:14), rep(-1000, 14), xlim=c(1, 14), ylim=c(0, 100), xlab="m", 
     ylab="classification success (percent)", type="n")
for (mseq in 1:14) {
  CAPdiscrim.result <- CAPdiscrim(soilz~Site, data=gen_env, 
                                  dist="gower", axes=2, m=mseq)
  points(mseq, CAPdiscrim.result$percent)
}


summary(CAPdiscrim(soilz~Site, data=gen_env, 
                                  dist="gower", axes=2))
```


```{r}
# #####Diversity and Evenness (as calculated in Gaskin 2006)
# bySite<-read.csv("G_N_bysite.csv")
# byPlot<-read.csv("G_N_bysiteplot.csv")
# GID_S<-read.csv("G_ID_Site.csv")
# GID_P<-read.csv("G_ID_Plot.csv")
# 
# GID_P$Site.Plot<-paste(GID_P$Site,GID_P$Plot,sep = ".")
# byPlot$Div<-0
# byPlot$Evn<-0
# 
# Di<-function(ram, N) { sum(ram*(ram-1)) / (N*(N-1))  }
# 
# 
# for(i in seq_along(byPlot$site.plot)) byPlot[i,"Div"]<- 1 - Di(GID_P[GID_P$Site.Plot==byPlot$site.plot[i],"N_G_ID"],10)
# 
# Dmin<-function(G,N) { ((G-1)*(2*N-G))/(N*(N-1)) }
# Dmax<-function(G,N) { (N*(G-1))/(G*(N-1)) }
# Ev<-function(D,Dmi,Dma) { (D - Dmi)/(Dma - Dmi)}
# 
# byPlot$Evn<-round(Ev(byPlot$Div,Dmi = Dmin(G=byPlot$plot.G,10),Dma = Dmax(byPlot$plot.G,10)),2)
#               
# plot(byPlot$Div,byPlot$Evn)  
# plot(byPlot$plot.freq,byPlot$Evn)
# plot(byPlot$av.stm.dens,byPlot$Evn)

```



```{r}
## do we need to account for site? 
### run discriminant analysis from principal coordinates of gower distance matrix
env2 <- gen_env[,c(11:ncol(gen_env))]
env2 <- as.matrix(env2)

# vegdist(env2, distance = "gower")
anosim <- anosim(env2, grouping = gen_env$Site, distance = "gower", permutations = 9999) 
anosim
plot(anosim)

adonis <- adonis2(env2 ~ gen_env$Site)
plot(adonis)

```


# CART
Do the same variables that divide sites also classify clonality?
```{r}
fitSite <-rpart(Site ~ pH+OM+Nitrate+K+S+Zn+Fe+Mn+Mg+Na+CEC+P, method = "class", data = gen_env)
fitClone <-rpart(Clone ~ pH+OM+Nitrate+K+S+Zn+Fe+Mn+Mg+Na+CEC+P, method = "class", data = gen_env)
```

```{r}
printcp(fitSite)
plot(fitSite)
text(fitSite)
# plotcp(fitSite)
summary(fitSite)
```


```{r}
printcp(fitClone)
plotcp(fitClone)
summary(fitClone)
plot(fitClone)
text(fitClone)
```


```{r}
pfit<- prune(fitSite, cp=fitSite$cptable[which.min(fitSite$cptable[,"xerror"]),"CP"])
printcp(pfit)

plot(pfit, uniform=TRUE,
     main="Pruned Classification Tree for Site")
text(pfit, use.n=TRUE, all=TRUE, cex=.8)
```


```{r}
pfitClone<- prune(fitClone, cp=fitClone$cptable[which.min(fitClone$cptable[,"xerror"]),"CP"])
printcp(pfitClone)

plot(pfitClone, uniform=TRUE,
     main="Pruned Classification Tree for Clones")
text(pfitClone, use.n=TRUE, all=TRUE, cex=.8)

```

### CI tree
```{r}
fit <- ctree(Site ~ pH+OM+Nitrate+K+S+Zn+Fe+Mn+Mg+Na+CEC+P,
             data=gen_env)
plot(fit, main="Conditional Inference Tree for Site")
```

######NMDS extras
```{r}
# nut.labs<-c("K","Clay","Na","S","Mg","BareG","P")
# 
# 
# md.soilz<-envfit(soilz.mds,gen_env[,c("K","S","Mg","Na","P","Sand","bare")])
# # md.soilz<-envfit(soilz.mds,gen_env[,names(soilz)])
# plot(md.soilz,lwd=2,col="black")#,labels =" ")
# # 
# # nut.vars<-locator(7)
# # soilz.mds$points[,1:2]
# #nut.vars<-locator(7)
# nut.labs<-c("K","Clay","Na","S","Mg","BareG","P")
# text(nut.vars,nut.labs,cex=2)
# clonz<-read.csv("G_N_bysite.csv")
# clonz.loc<-locator(6)
# text(clonz.loc,1:6)

```

```{r}
#library(stringi)
#byPlot$Site<-substr(byPlot$site.plot,1,1)
#byPlot$Plot<-substr(byPlot$site.plot,3,3)

#boxplot(byPlot$Evn~byPlot$Site)
#boxplot(byPlot$Div~byPlot$Site)

#bySite$Div<-0
#byPlot$Evn<-0

#for(i in seq_along(bySite$site)) bySite[i,"Div"]<- 1 - Di(GID_S[GID_S$Site==bySite$site[i],"N_G_ID"],30)
#bySite$Evn<-round(Ev(bySite$Div,Dmi = Dmin(G=bySite$site.G,30),Dma = Dmax(bySite$site.G,30)),2)
#plot(bySite$Div,bySite$Evn)

```


```{r}
####Principal Components Analysis -- making a soil nutrient variable
#gen_env<-gen_env[-which(gen_env$site.plot.subplot=="4.2.6"),]

#soilvar<-princomp(~pH+Salts+OM+Nitrate+K+S+Zn+Fe+Mn+Cu+Mg+Na+CEC+P, 
#                  data=gen_env, cor=FALSE, scores=TRUE)

#soilvar<-princomp(~K+S+Mg+Na+P, 
#                  data=gen_env, cor=FALSE, scores=TRUE)

#summary(soilvar)
#screeplot(soilvar)

#loadings(soilvar)
#gen_env$soil.nut<-soilvar$scores[,1]
```